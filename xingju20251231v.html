<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èˆˆå±…å®¤å…§è£ä¿® - å·¥ç¨‹ä¼°åƒ¹ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #e67e22;
            --bg-color: #f4f7f6;
            --border-color: #ddd;
        }

        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: #333;
        }

        .container {
            max-width: 950px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-radius: 8px;
        }

        /* --- æ¨™é¡Œå€åŸŸ --- */
        input.main-title-input {
            width: 100%;
            font-size: 36px;
            font-weight: bold;
            color: var(--primary-color);
            text-align: center;
            border: none;
            border-bottom: 2px solid transparent;
            background: transparent;
            margin-bottom: 20px;
            letter-spacing: 2px;
            outline: none;
            padding: 5px;
            font-family: inherit;
        }
        input.main-title-input:focus {
            border-bottom: 2px solid var(--accent-color);
            background-color: #fffef0;
        }

        /* --- å·¦å³åˆ†æ¬„ä½ˆå±€ --- */
        .info-split-container {
            display: flex;
            justify-content: space-between;
            gap: 40px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 20px;
        }

        .info-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px; /* è¡¨é ­è¡Œè· 1.5 å€ */
        }

        .info-row {
            display: flex;
            align-items: center;
        }

        .info-row label {
            font-weight: bold;
            min-width: 70px;
            color: #555;
            font-size: 15px;
        }

        /* é€šç”¨è¼¸å…¥æ¡†æ¨£å¼ */
        input.text-input, textarea.text-input {
            border: none;
            border-bottom: 1px solid #999;
            background: transparent;
            padding: 2px;
            font-size: 15px;
            font-family: inherit;
            flex-grow: 1;
            width: 100%;
            outline: none;
            transition: border-color 0.3s;
        }
        
        /* è¡¨é ­è¼¸å…¥æ¡†é«˜åº¦ */
        .info-panel input.text-input {
            padding: 6px 2px;
            font-size: 16px;
        }
        
        textarea.text-input {
            resize: none;
            overflow: hidden;
            vertical-align: top;
            min-height: 24px;
            line-height: 1.5;
            display: block; /* ç¢ºä¿ä½”æ»¿å®¹å™¨ */
            width: 100%;
        }

        input.text-input:focus, textarea.text-input:focus {
            border-bottom-color: var(--accent-color);
            background-color: #fffef0;
        }

        /* --- åˆ—å°å°ˆç”¨æ›¿èº« (é è¨­éš±è—) --- */
        .print-div {
            display: none; /* è¢å¹•ä¸Šä¸é¡¯ç¤º */
            white-space: pre-wrap; /* ä¿ç•™æ›è¡Œ */
            word-wrap: break-word; /* è‡ªå‹•æ›è¡Œ */
            border-bottom: 1px solid #000;
            min-height: 24px;
            line-height: 1.5;
            font-size: 15px;
            font-family: inherit;
            padding-top: 2px;
        }
        
        /* åŒ…è£¹ Textarea å’Œ PrintDiv çš„å®¹å™¨ */
        .print-wrap {
            flex-grow: 1;
            width: 100%;
            position: relative;
        }

        .right-align-input input.text-input {
            text-align: right;
        }
        
        .date-display {
            text-align: right;
            margin-top: 10px;
            font-size: 15px;
            color: #555;
        }

        /* --- è¡¨æ ¼æ¨£å¼ --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }

        th, td {
            padding: 6px 4px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 15px;
            vertical-align: top;
        }
        
        td.center-text, td.right-text {
            vertical-align: middle;
        }
        /* é‡å°å·¥ç¨‹é …ç›®æ¬„ä½ */
        td:nth-child(2) {
            vertical-align: top;
            padding-top: 8px;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: normal;
        }

        .center-text { text-align: center; }
        .right-text { text-align: right; }

        tr:hover { background-color: #f9f9f9; }

        /* æ‹–æ›³æ‰‹æŸ„ */
        .drag-handle {
            cursor: move;
            cursor: grab;
            color: #888;
            font-weight: bold;
            user-select: none;
            transition: color 0.2s;
            padding-top: 8px;
        }
        .drag-handle:hover {
            color: var(--accent-color);
            background-color: #f0f0f0;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        .sortable-ghost { opacity: 0.4; background-color: #e3f2fd; }
        .sortable-drag { background-color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        /* è¼¸å…¥æ¡† */
        input.qty-input, input.price-edit-input {
            width: 90%;
            min-width: 40px;
            padding: 2px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
            font-size: 15px;
            box-sizing: border-box;
        }
        
        input.price-edit-input, input.name-edit-input {
            display: none; 
            border-color: #2980b9; 
            background-color: #ebf5fb;
        }
        
        input.price-edit-input { text-align: right; }
        
        input.name-edit-input {
            width: 100%;
            padding: 2px;
            border: 1px solid #2980b9;
            border-radius: 4px;
            font-size: 15px;
            box-sizing: border-box;
        }

        .price-col, .subtotal-col {
            font-family: monospace;
            font-size: 15px;
        }

        .min-rule {
            font-size: 11px;
            color: #7f8c8d;
            display: block;
            margin-top: 2px;
        }

        /* --- åº•éƒ¨ä½ˆå±€å®¹å™¨ --- */
        .bottom-layout {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            margin-top: 10px;
        }

        .terms-section {
            width: 55%;
            border: 1px solid #000;
            padding: 15px;
            font-size: 14px;
            line-height: 1.6;
            text-align: left;
            box-sizing: border-box;
        }

        .right-summary-section {
            width: 40%;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: space-between;
        }

        .terms-title {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 8px;
            display: inline-block;
            background: #eee;
            padding: 3px 8px;
        }

        .term-item { display: flex; margin-bottom: 5px; }
        .term-num { min-width: 20px; }
        .term-content { flex-grow: 1; display: flex; } /* Flex è®“å…§å®¹æ’é–‹ */

        .total-section {
            text-align: right;
            padding-top: 10px;
            margin-bottom: 10px;
            border-top: 3px double var(--border-color);
            width: 100%;
            font-size: 16px;
            color: #333;
        }

        .total-row {
            margin-bottom: 5px;
        }

        .grand-total-row {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            margin-top: 5px;
            border-top: 1px solid #eee;
            padding-top: 5px;
        }

        .owner-sign-box {
            text-align: center;
            width: 100%;
        }

        .owner-sign-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 40px;
            text-align: center;
        }

        .owner-sign-line {
            border-bottom: 1px solid #000;
            height: 1px;
            width: 100%;
        }

        .actions {
            margin-top: 40px;
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            margin: 0 10px;
            transition: background 0.3s;
        }
        button:hover { background-color: #34495e; }
        button.btn-print { background-color: var(--accent-color); }
        button.btn-print:hover { background-color: #d35400; }
        
        button.btn-add { background-color: #27ae60; }
        button.btn-add:hover { background-color: #219150; }
        
        button.btn-edit-price { background-color: #8e44ad; }
        button.btn-edit-price:hover { background-color: #732d91; }
        button.btn-edit-price.active { background-color: #c0392b; }

        .delete-btn {
            color: red;
            cursor: pointer;
            font-weight: bold;
            margin-left: 5px;
            border: 1px solid red;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
        }
        .delete-btn:hover { background-color: red; color: white; }

        .print-only { display: none; }

        /* --- è‡ªå‹•æ’åºé‚è¼¯ --- */
        tbody {
            counter-reset: row-num;
        }
        tbody tr:not(.print-hidden) {
            counter-increment: row-num;
        }
        .index-cell::before {
            content: counter(row-num);
        }

        /* åˆ—å°å°ˆç”¨æ¨£å¼ */
        @media print {
            @page { margin: 1cm; }
            body { background: white; padding: 0; }
            .container { box-shadow: none; max-width: 100%; padding: 0; }
            
            .actions, .delete-btn { display: none !important; }

            /* å–®è¡Œè¼¸å…¥æ¡†åˆ—å°æ™‚ä¸æ›è¡Œ */
            input.text-input { 
                border-bottom: 1px solid #000; 
                padding: 4px 2px;
                white-space: nowrap; 
                overflow: hidden;    
            }
            
            /* ã€çµ‚æ¥µè§£æ³•ã€‘åˆ—å°æ™‚éš±è— Textareaï¼Œé¡¯ç¤º Div */
            textarea.text-input { display: none !important; }
            .print-div { 
                display: block !important; 
                border-bottom: 1px solid #000; /* ç¢ºä¿åº•ç·šå­˜åœ¨ */
                width: 100%;
            }
            
            /* è‡ªè¨‚é …ç›®çš„ Div ä¸è¦æœ‰åº•ç·š (å› ç‚ºåœ¨è¡¨æ ¼å…§) */
            .custom-row .print-div {
                border-bottom: none;
            }
            
            input.main-title-input { border: none; color: #000; text-align: center; }
            input.qty-input { display: none; }
            
            .price-display, .name-display { display: inline !important; }
            .price-edit-input, .name-edit-input { display: none !important; }

            .print-only { display: inline; }
            
            tr.empty-row { display: none; }

            th {
                background-color: #eee !important;
                color: black !important;
                -webkit-print-color-adjust: exact;
                padding: 6px 8px;
            }
            td {
                padding: 6px 8px;
            }
            
            .bottom-layout {
                display: flex;
                flex-direction: row;
                justify-content: space-between;
                page-break-inside: avoid;
            }
            
            .custom-row input {
                border: none;
                border-bottom: 1px solid transparent;
                text-align: center;
                width: 100%;
                padding: 0;
            }
            .custom-row input.text-input-left { text-align: left; }
            .custom-row input.text-input-right { text-align: right; }
            
            .drag-handle { cursor: default; }
        }
    </style>
</head>
<body>

<div class="container">
    <input type="text" class="main-title-input" value="èˆˆå±…å®¤å…§è£ä¿®è¨­è¨ˆå·¥ç¨‹æœ‰é™å…¬å¸" placeholder="è«‹è¼¸å…¥æ¨™é¡Œ">

    <div class="info-split-container">
        <div class="info-panel">
            <div class="info-row">
                <label>å®¢æˆ¶åç¨±:</label>
                <input type="text" class="text-input" placeholder="è«‹è¼¸å…¥å®¢æˆ¶å¤§å">
            </div>
            <div class="info-row">
                <label>è¯çµ¡é›»è©±:</label>
                <input type="text" class="text-input" placeholder="è«‹è¼¸å…¥é€£çµ¡é›»è©±">
            </div>
            <div class="info-row">
                <label>æ–½å·¥åœ°å€:</label>
                <input type="text" class="text-input" placeholder="è«‹è¼¸å…¥æ–½å·¥åœ°é»">
            </div>
            <div class="info-row">
                <label>é è¨ˆå·¥æœŸ:</label>
                <input type="text" class="text-input" placeholder="ä¾‹: é€²å ´å¾Œ15å€‹å·¥ä½œå¤©">
            </div>
        </div>

        <div class="info-panel">
            <div class="info-row right-align-input">
                <label>è¯çµ¡äºº:</label>
                <input type="text" class="text-input" placeholder="è«‹è¼¸å…¥å§“å">
            </div>
            <div class="info-row right-align-input">
                <label>è¯çµ¡é›»è©±:</label>
                <input type="text" class="text-input" placeholder="è«‹è¼¸å…¥é›»è©±">
            </div>
            <div class="info-row right-align-input">
                <label>å…¬å¸åœ°å€:</label>
                <input type="text" class="text-input" value="å½°åŒ–å¸‚é‡‘é¦¬è·¯ 2 æ®µ 519 è™Ÿ">
            </div>
            <div class="info-row">
                <label style="width: 100%; text-align: right;">
                    <span id="date-display" class="date-display"></span>
                </label>
            </div>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 5%;" class="center-text">é …æ¬¡</th>
                <th style="width: 55%;">å·¥ç¨‹é …ç›®</th>
                <th style="width: 11%;" class="right-text">å–®åƒ¹</th>
                <th style="width: 6%;" class="center-text">å–®ä½</th>
                <th style="width: 10%;" class="center-text">æ•¸é‡</th>
                <th style="width: 13%;" class="right-text">è¤‡åƒ¹ (NT$)</th>
            </tr>
        </thead>
        <tbody id="quotation-body">
            </tbody>
    </table>
    
    <div style="text-align: left; margin-bottom: 20px;" class="actions">
        <button onclick="addCustomRow()" class="btn-add">+ æ–°å¢è‡ªè¨‚é …ç›®</button>
        <button onclick="togglePriceEdit()" id="btn-price-toggle" class="btn-edit-price">ğŸ”“ ä¿®æ”¹å–®åƒ¹,å·¥ç¨‹é …ç›®</button>
    </div>

    <div class="bottom-layout">
        
        <div class="terms-section">
            <div class="terms-title">å‚™è¨»æ¢æ¬¾</div>
            <div class="term-item">
                <div class="term-num">1.</div>
                <div class="term-content">
                    <div class="print-wrap">
                        <textarea class="text-input auto-resize" rows="1" placeholder="è«‹è¼¸å…¥æ”¶æ¬¾æ–¹å¼ (æ–‡å­—éé•·æœƒè‡ªå‹•æ›è¡Œ)"></textarea>
                        <div class="print-div"></div>
                    </div>
                </div>
            </div>
            <div class="term-item">
                <div class="term-num">2.</div>
                <div class="term-content">å–®åƒ¹çš†ç‚ºç¾é‡‘åƒ¹ä¸å«ç¨…, ç‡Ÿæ¥­ç¨…å¤–åŠ </div>
            </div>
            <div class="term-item">
                <div class="term-num">3.</div>
                <div class="term-content">æœ¬å ±åƒ¹å–®ç°½ç´„å‰ç‚ºå…¬å¸å…§éƒ¨æ©Ÿå¯†è³‡æ–™ï¼Œéç¶“æœ¬å…¬å¸åŒæ„ç¦æ­¢è½‰å‚³é–±</div>
            </div>
            <div class="term-item">
                <div class="term-num">4.</div>
                <div class="term-content">æ–°è¨­å‚™æœ‰éäººç‚ºæå£ ä¸€å¹´æœŸ å…¬å¸ä¿å›º</div>
            </div>
            <div class="term-item">
                <div class="term-num">5.</div>
                <div class="term-content">æœ¬å ±åƒ¹å–®æ¥­ä¸»ç°½ç« ä»˜è¨‚å¾Œå‰‡è½‰ç‚ºæ­£å¼åˆç´„å£¹å¼å…©ä»½</div>
            </div>
            <div class="term-item">
                <div class="term-num">6.</div>
                <div class="term-content">æœ€çµ‚åƒ¹æ ¼ä»¥ç¾å ´å¯¦éš›ä¸ˆé‡åŠé›™æ–¹ç¢ºèªç‚ºæº–</div>
            </div>
        </div>

        <div class="right-summary-section">
            <div class="total-section">
                <div class="total-row">å·¥ç¨‹ç¸½åƒ¹: NT$ <span id="subtotal-display">0</span></div>
                <div class="total-row">ç‡Ÿæ¥­ç¨… (5%): NT$ <span id="tax-display">0</span></div>
                <div class="total-row grand-total-row">ç¸½è¨ˆ (å«ç¨…): NT$ <span id="grand-total-display">0</span></div>
            </div>
            
            <div class="owner-sign-box">
                <div class="owner-sign-title">æ¥­ä¸»åˆç´„ç¢ºèªç°½åè™•</div>
                <br>
                <div class="owner-sign-line"></div>
            </div>
        </div>

    </div>

    <div class="actions">
        <button onclick="window.print()" class="btn-print">åˆ—å° / å¦å­˜PDF</button>
        <button onclick="resetForm()">æ¸…é™¤å…¨éƒ¨</button>
    </div>
</div>

<script>
    // é …ç›®è³‡æ–™åº«
    const items = [
        { name: "æ‰“çŸ³è¦‹åº•å«æ¸…é‹", unit: "åª", price: 4000, min: 3 },
        { name: "æ‰“çŸ³ä¸è¦‹åº•å«æ¸…é‹", unit: "åª", price: 3000, min: 3 },
        { name: "ç£šç‰†æ‰“é™¤å«æ¸…é‹", unit: "åª", price: 5000, min: 3 },
        { name: "RCç‰†æ‰“é™¤å«æ¸…é‹", unit: "åª", price: 6000, min: 3 },
        { name: "RCå»šå…·(åƒ…æª¯æ«ƒ) æ‰“é™¤å«æ¸…é‹", unit: "ç±³", price: 10000, min: 1 },
        { name: "æ‹†æœ¨ä½œé«˜æ«ƒé«”å«æ¸…é‹", unit: "å°º", price: 1500, min: 6 },
        { name: "æ‹†æœ¨ä½œä¸‹å»šæ«ƒé«”å«æ¸…é‹", unit: "å°º", price: 1000, min: 8 },
        { name: "æ‹†æœ¨ä½œ,è¼•é‹¼æ¶å¤©èŠ±æ¿å«æ¸…é‹", unit: "åª", price: 800, min: 10 },
        { name: "ç Œ4å‹ç´…ç£šéš”é–“ç‰† (å«é›™é¢æ°´æ³¥ç²‰åˆ·)", unit: "åª", price: 13000, min: 1 },
        { name: "æ°´æ³¥ç²‰åˆ·,ç²‰å…‰", unit: "åª", price: 2500, min: 4 },
        { name: "å£è²¼ç›Šè† æ³¥ è²¼ç£ç£š30x60ä»¥å…§", unit: "åª", price: 9000, min: 1 },
        { name: "åœ°æ¿åšè»Ÿåº• è²¼ç£ç£š50x50ä»¥å…§ (è»Ÿåº•5å…¬åˆ†å…§)", unit: "åª", price: 9000, min: 1 },
        { name: "åœ°æ¿æ°´æ³¥ç ‚æ‰“åº• 5å…¬åˆ†å…§", unit: "åª", price: 3000, min: 3 },
        { name: "åœ°æ¿æ°´æ³¥ç ‚æ‰“åº• 10å…¬åˆ†å…§", unit: "åª", price: 4500, min: 3 },
        { name: "åšé˜²æ°´åº•æ¼†ä¸€æ¬¡+å½ˆæ€§é¢æ¼†å…©æ¬¡", unit: "åª", price: 2000, min: 3 },
        { name: "çŸ½é…¸éˆ£æ¿è¼•é‹¼æ¶å¤©èŠ±æ¿", unit: "åª", price: 2200, min: 3 },
        { name: "æœ¨ä½œçŸ½é…¸éˆ£æ¿å¤©èŠ±æ¿6mm", unit: "åª", price: 4200, min: 2 },
        { name: "æ‰¹ABè† é€æ‰¹ç™½åœŸ", unit: "åª", price: 1800, min: 3 },
        { name: "çª—ç°¾ç›’æ‰¹ABè† é€æ‰¹ç™½åœŸ", unit: "å°º", price: 300, min: 8 },
        { name: "å†·æ°£ç›’æ‰¹ABè† é€æ‰¹ç™½åœŸ", unit: "å€‹", price: 2300, min: 2 },
        { name: "å£é¢æ°´æ³¥æ¼†åˆ·ä¸‰æ¬¡ (ä¸åŒ…å«æ‰¹å­”)", unit: "åª", price: 800, min: 6 },
        { name: "æœ¨ä½œ6mmçŸ½é…¸éˆ£æ¿å–®é¢éš”é–“", unit: "åª", price: 4200, min: 2 },
        { name: "æœ¨ä½œ6mmçŸ½é…¸éˆ£æ¿é›™é¢éš”é–“", unit: "åª", price: 5300, min: 2 },
        { name: "ç„¡è£æ½¢å®¤å…§é›»ç‡ˆæ’åº§æŠ½æ›ç·š (åŒ…å«åœ‹éš›æ˜Ÿå…‰é¢æ¿)", unit: "å€‹", price: 1000, min: 5 },
        { name: "æµ´å®¤ç¯„åœé…çµ¦æ’æ°´ç®¡ä¸€å¥— èˆŠæ”¹æ–°", unit: "é–“", price: 25000, min: 1 }, 
        { name: "æµ´å®¤è¡›æµ´è¨­å‚™å®‰è£", unit: "é–“", price: 5500, min: 1 },
        { name: "HCGå’Œæˆç‰ŒåŸºæœ¬æ¬¾è¡›æµ´è¨­å‚™(é¦¬æ¡¶+è‡‰ç›†+è‡‰ç›†é¾é ­+æ²æµ´é¾é ­+é¡å­)", unit: "å¥—", price: 15000, min: 1 }
    ];

    const tbody = document.getElementById('quotation-body');
    const dateDisplay = document.getElementById('date-display');
    const priceToggleBtn = document.getElementById('btn-price-toggle');
    
    let isPriceEditing = false; 

    const today = new Date();
    dateDisplay.innerText = `å ±åƒ¹æ—¥æœŸ: ${today.getFullYear()}/${String(today.getMonth() + 1).padStart(2, '0')}/${String(today.getDate()).padStart(2, '0')}`;

    // --- SortableJS åˆå§‹åŒ– ---
    new Sortable(tbody, {
        handle: '.drag-handle',
        animation: 150,
        ghostClass: 'sortable-ghost',
        dragClass: 'sortable-drag',
    });

    function initTable() {
        items.forEach((item, index) => {
            const tr = document.createElement('tr');
            tr.className = 'empty-row'; 
            
            let minRuleText = "";
            if (item.min > 1) {
                minRuleText = `<span class="min-rule" id="rule-${index}">(ä¸æ»¿${item.min}${item.unit}ä»¥${item.min}${item.unit}è¨ˆ)</span>`;
            }

            tr.innerHTML = `
                <td class="center-text drag-handle" title="æŒ‰ä½æ­¤è™•æ‹–æ›³æ’åº"><span class="index-cell"></span></td>
                <td>
                    <span class="name-display" id="name-display-${index}">${item.name}</span>
                    <input type="text" class="name-edit-input" id="name-input-${index}" value="${item.name}" oninput="updateItemName(${index}, this.value)">
                    ${minRuleText}
                </td>
                <td class="price-col right-text">
                    <span class="price-display" id="price-display-${index}">${item.price.toLocaleString()}</span>
                    <input type="number" class="price-edit-input" id="price-input-${index}" value="${item.price}" oninput="updateItemPrice(${index}, this.value)">
                </td>
                <td class="center-text">${item.unit}</td>
                <td class="center-text">
                    <input type="number" class="qty-input" min="0" step="0.1" oninput="calculateRow(${index}, this.value)" placeholder="0">
                    <span class="print-only" id="print-qty-${index}"></span>
                </td>
                <td class="subtotal-col right-text" id="subtotal-${index}">0</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function togglePriceEdit() {
        isPriceEditing = !isPriceEditing;
        
        const priceDisplays = document.querySelectorAll('.price-display');
        const priceInputs = document.querySelectorAll('.price-edit-input');
        const nameDisplays = document.querySelectorAll('.name-display');
        const nameInputs = document.querySelectorAll('.name-edit-input');
        
        if (isPriceEditing) {
            priceToggleBtn.innerText = "ğŸ”’ é–å®šç·¨è¼¯ (å®Œæˆ)";
            priceToggleBtn.classList.add('active');
            
            priceDisplays.forEach(el => el.style.display = 'none');
            priceInputs.forEach(el => el.style.display = 'inline-block');
            
            nameDisplays.forEach(el => el.style.display = 'none');
            nameInputs.forEach(el => el.style.display = 'inline-block');
        } else {
            priceToggleBtn.innerText = "ğŸ”“ ä¿®æ”¹å–®åƒ¹,å·¥ç¨‹é …ç›®";
            priceToggleBtn.classList.remove('active');
            
            priceDisplays.forEach(el => el.style.display = 'inline');
            priceInputs.forEach(el => el.style.display = 'none');
            
            nameDisplays.forEach(el => el.style.display = 'inline');
            nameInputs.forEach(el => el.style.display = 'none');
        }
    }

    function updateItemPrice(index, newPrice) {
        const price = parseFloat(newPrice) || 0;
        items[index].price = price; 
        document.getElementById(`price-display-${index}`).innerText = price.toLocaleString();
        const qtyInput = document.querySelectorAll('.qty-input')[index];
        calculateRow(index, qtyInput.value);
    }
    
    function updateItemName(index, newName) {
        items[index].name = newName;
        document.getElementById(`name-display-${index}`).innerText = newName;
    }

    function calculateRow(index, value) {
        const item = items[index];
        const qty = parseFloat(value);
        const subtotalEl = document.getElementById(`subtotal-${index}`);
        const printQtyEl = document.getElementById(`print-qty-${index}`);
        const ruleEl = document.getElementById(`rule-${index}`); 
        const row = subtotalEl.closest('tr');

        if (ruleEl) {
            if (qty >= item.min) {
                ruleEl.style.display = 'none'; 
            } else {
                ruleEl.style.display = 'inline'; 
            }
        }

        if (isNaN(qty) || qty === 0) {
            subtotalEl.innerText = "0";
            printQtyEl.innerText = "";
            row.classList.add('empty-row'); 
            updateTotal();
            return;
        }

        row.classList.remove('empty-row'); 

        let billingQty = qty;
        let isMinCharge = false;

        if (qty < item.min) {
            billingQty = item.min;
            isMinCharge = true;
        }

        const total = billingQty * item.price;
        subtotalEl.innerText = total.toLocaleString();
        
        if (isMinCharge) {
            printQtyEl.innerText = `${qty} (ä»¥${item.min}è¨ˆ)`;
        } else {
            printQtyEl.innerText = qty;
        }

        updateTotal();
    }

    function addCustomRow() {
        const tr = document.createElement('tr');
        tr.className = 'custom-row'; 
        
        tr.innerHTML = `
            <td class="center-text drag-handle" title="æŒ‰ä½æ­¤è™•æ‹–æ›³æ’åº"><span class="index-cell"></span></td>
            <td>
                <div class="print-wrap">
                    <textarea class="text-input text-input-left auto-resize" rows="1" placeholder="è¼¸å…¥å·¥ä½œé …ç›®åç¨± (è‡ªå‹•æ›è¡Œ)"></textarea>
                    <div class="print-div"></div>
                </div>
            </td>
            <td class="right-text">
                <input type="number" class="text-input text-input-right price-input" placeholder="å–®åƒ¹" oninput="calculateCustomRow(this)">
            </td>
            <td class="center-text">
                <input type="text" class="text-input" style="text-align:center;" placeholder="å–®ä½">
            </td>
            <td class="center-text">
                <input type="number" class="qty-input" min="0" step="0.1" oninput="calculateCustomRow(this)" placeholder="0">
                <span class="print-only custom-qty-print"></span>
            </td>
            <td class="subtotal-col right-text">0 <span class="delete-btn" onclick="removeCustomRow(this)" title="åˆªé™¤æ­¤è¡Œ">âœ•</span></td>
        `;
        tbody.appendChild(tr);
    }

    function calculateCustomRow(input) {
        const row = input.closest('tr');
        const priceInput = row.querySelector('.price-input');
        const qtyInput = row.querySelector('.qty-input');
        const subtotalEl = row.querySelector('.subtotal-col');
        const printQtyEl = row.querySelector('.custom-qty-print');
        
        const price = parseFloat(priceInput.value) || 0;
        const qty = parseFloat(qtyInput.value) || 0;
        
        const total = price * qty;
        
        subtotalEl.innerHTML = `${total.toLocaleString()} <span class="delete-btn" onclick="removeCustomRow(this)" title="åˆªé™¤æ­¤è¡Œ">âœ•</span>`;
        
        printQtyEl.innerText = qtyInput.value;

        updateTotal();
    }

    function removeCustomRow(btn) {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤é …ç›®ï¼Ÿ")) {
            const row = btn.closest('tr');
            row.remove();
            updateTotal();
        }
    }

    function updateTotal() {
        let subtotal = 0;
        const subtotalEls = document.querySelectorAll('.subtotal-col');
        
        subtotalEls.forEach(el => {
            subtotal += parseInt(el.innerText.replace(/,/g, '').replace('âœ•', '')) || 0;
        });

        // è¨ˆç®—ç¨…é‡‘
        const tax = Math.round(subtotal * 0.05);
        const grandTotal = subtotal + tax;

        document.getElementById('subtotal-display').innerText = subtotal.toLocaleString();
        document.getElementById('tax-display').innerText = tax.toLocaleString();
        document.getElementById('grand-total-display').innerText = grandTotal.toLocaleString();
    }

    function resetForm() {
        if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¼¸å…¥å—ï¼Ÿ")) {
            const qtyInputs = document.querySelectorAll('.qty-input');
            qtyInputs.forEach(input => {
                input.value = '';
                input.dispatchEvent(new Event('input'));
            });
            const textInputs = document.querySelectorAll('.text-input');
            textInputs.forEach(input => {
                if (input.value !== "å½°åŒ–å¸‚é‡‘é¦¬è·¯ 2 æ®µ 519 è™Ÿ" && !input.classList.contains('auto-resize')) {
                   input.value = '';
                }
                if (input.tagName === 'TEXTAREA') {
                    input.value = '';
                    input.style.height = 'auto';
                    // åŒæ­¥æ¸…é™¤ print-div å…§å®¹
                    const printDiv = input.nextElementSibling;
                    if(printDiv && printDiv.classList.contains('print-div')) {
                        printDiv.textContent = '';
                    }
                }
            });
            const customRows = document.querySelectorAll('.custom-row');
            customRows.forEach(row => row.remove());
            
            updateTotal();
        }
    }

    // ã€åŒæ­¥æ–‡å­—ã€‘ç•¶ Textarea è¼¸å…¥æ™‚ï¼ŒåŒæ­¥æ›´æ–°åˆ°éš±è—çš„ Div
    document.addEventListener('input', function (event) {
        if (event.target.classList.contains('auto-resize')) {
            const textarea = event.target;
            
            // 1. è‡ªå‹•èª¿æ•´ Textarea é«˜åº¦ (è¢å¹•é¡¯ç¤ºç”¨)
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
            
            // 2. åŒæ­¥å…§å®¹åˆ° Print Div (åˆ—å°ç”¨)
            const printDiv = textarea.nextElementSibling;
            if (printDiv && printDiv.classList.contains('print-div')) {
                printDiv.textContent = textarea.value;
            }
        }
    }, false);

    initTable();
</script>

</body>
</html>
