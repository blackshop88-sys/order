<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é®®å¥¶é…ª - ç·šä¸Šé è¨‚</title>
    <style>
        /* --- åŸºç¤æ¨£å¼ --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, sans-serif; }
        body { background-color: #f5f5f5; color: #333; padding-bottom: 140px; }
        
        /* Header */
        header { 
            background-color: #fff; padding: 15px; 
            text-align: center; font-weight: bold; font-size: 1.3rem; 
            position: sticky; top: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            z-index: 100; 
            display: flex; align-items: center; justify-content: center; gap: 15px; 
        }
        .header-logo { height: 80px; width: auto; border-radius: 8px; }

        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        .section-header { font-size: 1.1rem; font-weight: bold; margin: 25px 0 10px 0; display: flex; align-items: center; color: #444; }
        .section-header::before { content: ''; display: inline-block; width: 5px; height: 18px; background: #00c300; margin-right: 8px; border-radius: 2px; }
        
        /* èœå–® */
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .menu-item { background: #fff; border-radius: 10px; padding: 10px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border: 1px solid #eee; text-align: center; }
        
        .menu-img { 
            width: 100%; 
            aspect-ratio: 1 / 1; 
            object-fit: cover;    
            border-radius: 8px; 
            margin-bottom: 8px; 
            background-color: #eee; 
        }
        .menu-name { font-size: 1rem; font-weight: 600; margin-bottom: 3px; line-height: 1.2; }
        /* æè¿°æ–‡å­—æ¨£å¼ */
        .menu-desc { font-size: 0.8rem; color: #666; margin-bottom: 8px; line-height: 1.4; min-height: 3.5em; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        
        .menu-price { color: #d63031; font-weight: bold; font-size: 1rem; margin-bottom: 8px; }
        .add-btn { background: #fff; border: 1px solid #00c300; color: #00c300; padding: 5px 20px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: 0.2s; font-weight: bold; }
        .add-btn:active { background: #00c300; color: #fff; }

        /* è³¼ç‰©è»Š */
        .cart-item { background: #fff; border-radius: 10px; padding: 12px; margin-bottom: 10px; display: flex; align-items: center; border-left: 5px solid #ddd; }
        .cart-info { flex: 1; margin-left: 10px; }
        .cart-title { font-weight: bold; font-size: 1rem; }
        .cart-subtotal { color: #888; font-size: 0.85rem; margin-top: 3px; }
        .qty-control { display: flex; align-items: center; gap: 8px; }
        .qty-btn { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #ddd; background: #fff; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; }

        /* è¡¨å–® */
        .options-section { background: #fff; border-radius: 10px; padding: 20px; margin-top: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 0.9rem; margin-bottom: 5px; color: #666; }
        .form-input { width: 100%; padding: 12px; font-size: 1rem; border: 1px solid #ddd; border-radius: 8px; background: #fdfdfd; outline: none; }
        textarea.form-input { resize: vertical; min-height: 80px; font-family: inherit; }
        .form-input:focus { border-color: #00c300; }
        .form-input:disabled { background-color: #e9ecef; cursor: not-allowed; color: #6c757d; }
        
        .radio-group { display: flex; gap: 15px; margin-bottom: 15px; }
        .radio-label { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 5px; cursor: pointer; }
        .radio-input:checked + span { color: #00c300; font-weight: bold; }
        #address-row { display: none; }

        /* åº•éƒ¨ */
        .bottom-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; padding: 12px 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; z-index: 999; }
        .price-area { display: flex; flex-direction: column; }
        .total-price { font-size: 1.3rem; font-weight: bold; color: #d63031; }
        .discount-tag { font-size: 0.75rem; background: #ff4757; color: white; padding: 2px 6px; border-radius: 4px; margin-left: 5px; display: none; }
        .promo-hint { font-size: 0.75rem; color: #e63946; margin-top: 4px; line-height: 1.4; font-weight: bold; }
        
        .checkout-btn { background-color: #00c300; color: #fff; border: none; padding: 12px 35px; border-radius: 25px; font-size: 1rem; font-weight: bold; cursor: pointer; }
        .checkout-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .empty-cart-msg { text-align: center; color: #aaa; padding: 20px; font-size: 0.9rem; }

        /* æ”¶æ“šé  */
        #receipt-view { display: none; background: #fff; min-height: 100vh; padding: 20px; text-align: center; }
        .receipt-logo { width: 80px; height: auto; margin-bottom: 15px; border-radius: 10px; }
        .receipt-icon { font-size: 3rem; color: #00c300; margin-bottom: 10px; }
        .receipt-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; }
        .receipt-time { color: #888; font-size: 0.9rem; margin-bottom: 20px; }
        .receipt-card { background: #f9f9f9; border-radius: 10px; padding: 15px; text-align: left; margin-bottom: 20px; border: 1px dashed #ddd; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; }
        .receipt-row.bold { font-weight: bold; border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px; font-size: 1.1rem; }
        
        .receipt-bank-box { background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left; border: 1px solid #c8e6c9; }
        .bank-title { color: #2e7d32; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        .bank-detail { font-size: 1.1rem; font-weight: bold; color: #333; letter-spacing: 1px; }
        
        .screenshot-box { background: #fff8e1; border: 2px dashed #ffc107; padding: 15px; margin: 20px 0; border-radius: 10px; color: #ff6f00; display: flex; align-items: center; justify-content: center; gap: 10px; text-align: left; }
        .screenshot-icon { font-size: 1.8rem; }
        .screenshot-text { font-size: 1rem; font-weight: bold; line-height: 1.4; }

        .pay-btn { display: block; width: 100%; padding: 15px; background: #00c300; color: white; text-decoration: none; border-radius: 30px; font-weight: bold; margin-bottom: 15px; }
        .home-btn { background: #fff; color: #666; border: 1px solid #ddd; }
        
        #loading-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #00c300; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div>æ­£åœ¨å‚³é€è¨‚å–®...</div>
    </div>

    <div id="shop-view">
        <header>
            <img src="logo.jpg" alt="Logo" class="header-logo">
            <span>ç·šä¸Šé è¨‚</span>
        </header>

        <div class="container">
            <div class="section-header">é¸æ“‡å£å‘³</div>
            <div class="menu-grid" id="menu-list"></div>

            <div class="section-header">æ‚¨çš„è³¼ç‰©è»Š</div>
            <div id="cart-list">
                <div class="empty-cart-msg">å°šæœªåŠ å…¥å•†å“</div>
            </div>

            <div class="section-header">è¨‚è³¼è³‡è¨Š</div>
            <div class="options-section">
                
                <div class="form-label" style="margin-bottom:8px;">å–è²¨æ–¹å¼</div>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="deliveryMethod" value="è‡ªå–" class="radio-input" checked onchange="updateDateSettings('pickup')">
                        <span>è‡ªå–</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="deliveryMethod" value="å®…é…" class="radio-input" onchange="updateDateSettings('delivery')">
                        <span>å®…é… (å†·è—)</span>
                    </label>
                </div>

                <div class="form-label" style="margin-bottom:8px;">ä»˜æ¬¾æ–¹å¼</div>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="paymentMethod" value="linepay" class="radio-input" checked>
                        <span>LINE Pay</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="paymentMethod" value="bank" class="radio-input">
                        <span>éŠ€è¡ŒåŒ¯æ¬¾</span>
                    </label>
                </div>

                <div class="form-group">
                    <label class="form-label" id="date-label">å–è²¨/åˆ°è²¨æ—¥æœŸ</label>
                    <input type="date" id="pickup-date" class="form-input" onchange="validateDate()">
                    <div style="font-size:0.85rem; color:#d63031; margin-top:5px; font-weight:bold;" id="date-hint"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">å§“å</label>
                    <input type="text" id="cust-name" class="form-input" placeholder="æ‚¨çš„ç¨±å‘¼">
                </div>
                <div class="form-group">
                    <label class="form-label">æ‰‹æ©Ÿ</label>
                    <input type="tel" id="cust-phone" class="form-input" placeholder="09xx-xxx-xxx" maxlength="10">
                </div>
                
                <div class="form-group" id="address-row">
                    <label class="form-label">å®…é…åœ°å€</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <select id="cust-city" class="form-input">
                            <option value="" disabled selected>è«‹é¸æ“‡ç¸£å¸‚</option>
                            <option value="åŸºéš†å¸‚">åŸºéš†å¸‚</option>
                            <option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option>
                            <option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
                            <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
                            <option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option>
                            <option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option>
                            <option value="è‹—æ —ç¸£">è‹—æ —ç¸£</option>
                            <option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option>
                            <option value="å½°åŒ–å¸‚">å½°åŒ–å¸‚</option>
                            <option value="å½°åŒ–ç¸£">å½°åŒ–ç¸£</option>
                            <option value="å—æŠ•ç¸£">å—æŠ•ç¸£</option>
                            <option value="é›²æ—ç¸£">é›²æ—ç¸£</option>
                            <option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
                            <option value="å˜‰ç¾©ç¸£">å˜‰ç¾©ç¸£</option>
                            <option value="å°å—å¸‚">å°å—å¸‚</option>
                            <option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
                            <option value="å±æ±ç¸£">å±æ±ç¸£</option>
                            <option value="å®œè˜­ç¸£">å®œè˜­ç¸£</option>
                            <option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
                            <option value="å°æ±ç¸£">å°æ±ç¸£</option>
                            <option value="æ¾æ¹–ç¸£">æ¾æ¹–ç¸£</option>
                            <option value="é‡‘é–€ç¸£">é‡‘é–€ç¸£</option>
                            <option value="é€£æ±Ÿç¸£">é€£æ±Ÿç¸£</option>
                        </select>
                        <input type="text" id="cust-addr-detail" class="form-input" placeholder="é„‰é®å¸‚å€ / è¡—é“ / é–€è™Ÿ">
                    </div>
                </div>

                <div class="form-group" style="margin-top: 15px;">
                    <label class="form-label">å‚™è¨» (æ¯ç›’ 6 å…¥ï¼Œè‹¥éœ€åˆ†è£è«‹å¡«å¯«)</label>
                    <textarea id="cust-remarks" class="form-input" rows="2" placeholder="ä¾‹å¦‚ï¼šåŸå‘³x2 å·§å…‹åŠ›x2 æŠ¹èŒ¶x2 è£ä¸€ç›’"></textarea>
                </div>

            </div>
        </div>

        <div class="bottom-bar">
            <div class="price-area">
                <div style="font-size:0.8rem; color:#666;">
                    è¨‚å–®é‡‘é¡ (å…± <span id="total-cups-badge" style="font-weight:bold; color:#333;">0</span> å€‹)
                    <span id="discount-badge" class="discount-tag">95æŠ˜</span>
                </div>
                <div class="total-price">NT$ <span id="final-total">0</span></div>
                <div class="promo-hint">
                    æ»¿ $3000 æ‰“ 95 æŠ˜ / æ»¿ $5000 æ‰“ 9 æŠ˜<br>
                    æ»¿ 6 å…¥ç›’è£
                </div>
            </div>
            <button class="checkout-btn" id="submit-btn" onclick="processCheckout()">ç¢ºèªé€å‡º</button>
        </div>
    </div>

    <div id="receipt-view">
        <img src="logo.jpg" alt="Logo" class="receipt-logo">
        <div class="receipt-icon">âœ”</div>
        <div class="receipt-title">è¨‚å–®å·²æˆç«‹</div>
        <div class="receipt-time" id="receipt-time"></div>

        <div class="receipt-card">
            <div id="receipt-items"></div>
            <div class="receipt-row bold">
                <span>ç¸½é‡‘é¡ (å«é‹)</span>
                <span style="color:#d63031" id="receipt-total"></span>
            </div>
        </div>

        <div class="receipt-card">
            <div class="receipt-row"><span>ç¸½æ•¸é‡</span><span id="receipt-cups"></span></div>
            <div class="receipt-row"><span>è¨‚è³¼äºº</span><span id="receipt-name"></span></div>
            <div class="receipt-row"><span>é›»è©±</span><span id="receipt-phone"></span></div>
            <div class="receipt-row"><span>å–è²¨æ–¹å¼</span><span id="receipt-delivery"></span></div>
            <div class="receipt-row"><span>æ—¥æœŸ</span><span id="receipt-date"></span></div>
            <div class="receipt-row" id="receipt-address-row" style="display:none;">
                <span>åœ°å€</span><span id="receipt-address"></span>
            </div>
            <div class="receipt-row" id="receipt-remarks-row" style="display:none; flex-direction:column; align-items:flex-start;">
                <span style="color:#666; font-size:0.9rem;">å‚™è¨»</span>
                <span id="receipt-remarks" style="color:#333; font-weight:bold; margin-top:3px;"></span>
            </div>
        </div>

        <div id="bank-info-area" class="receipt-bank-box" style="display:none;">
            <div class="bank-title">è«‹åŒ¯æ¬¾è‡³ä»¥ä¸‹å¸³è™Ÿï¼š</div>
            <div style="margin-bottom:5px;">ç‰å±±éŠ€è¡Œ (808)</div>
            <div class="bank-detail">0336979095995</div>
            <div style="font-size:0.9rem; color:#666; margin-top:5px;">æˆ¶åï¼šé‡‘å† åŸ</div>
        </div>

        <div class="screenshot-box">
            <div class="screenshot-icon">ğŸ“¸</div>
            <div class="screenshot-text">
                è«‹æˆªåœ–æ­¤ç•«é¢<br>
                ä¸¦å‚³é€çµ¦å®˜æ–¹å®¢æœ LINE
            </div>
        </div>

        <a id="linepay-btn" href="#" class="pay-btn" style="display:none;">å‰å¾€ LINE Pay ä»˜æ¬¾</a>
        <button onclick="window.location.reload()" class="pay-btn home-btn">è¿”å›é¦–é  / å†ä¸‹ä¸€å–®</button>
    </div>

    <script>
        // --- è¨­å®šå€ ---
        
        // Google Form å›å‚³ç¶²å€
        const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSenpCJdVZWJ4seiaz4GimXwasppPbnX3o1pLGyrnIMWaJ_sqw/formResponse";
        
        // Google Form æ¬„ä½ ID
        const FORM_FIELDS = {
            orderContent: "entry.1214769536", 
            name:         "entry.537178649",  
            phone:        "entry.1240845794", 
            payment:      "entry.36879241",   
            delivery:     "entry.2126181854", 
            address:      "entry.1346414492", 
            date:         "entry.1111858266", 
            cups:         "entry.1482122773", 
            subtotal:     "entry.1558685102", 
            shipping:     "entry.1750953999", 
            totalPrice:   "entry.816848611"   
        };

        // LINE Pay é€£çµ
        const LINE_PAY_LINK = "https://qrcodepay.line.me/qr/payment/uemRyQGLoTi6F3OUSEUgEtlr9QjZ1vTlUUVy930W3RPAgapaVWJM%252BrFuHzZRvpGA";
        
        // â˜…â˜…â˜… å•†å“è³‡æ–™æ›´æ–° (åƒ¹æ ¼å·²èª¿æ•´ç‚º 45/50) â˜…â˜…â˜…
        const menuData = [
            { id: 1, name: "ç¶“å…¸åŸå‘³", price: 45, image: "230242.jpg", desc: "æ¿ƒéƒå¥¶é¦™ã€ç¶¿å¯†æ»‘é †ï¼Œç†±è³£å¿…è²·çš„äººæ°£å£å‘³ã€‚" },
            { id: 2, name: "å·§å…‹åŠ›", price: 50, image: "230240_0.jpg", desc: "é¸ç”¨æ³•èŠ™å¨œå¯å¯ï¼Œå¯å¯é¦™æ¿ƒéƒï¼Œå¤§äººå°å­©éƒ½æ„›ã€‚" },
            { id: 3, name: "èŠéº»", price: 50, image: "230239_0.jpg", desc: "åš´é¸ 100% é»‘èŠéº»ç ”ç£¨ï¼ŒèŠéº»é¦™æ°£æ¿ƒåšï¼Œå£æ„Ÿå¾®é¡†ç²’ã€‚" },
            { id: 4, name: "æŠ¹èŒ¶", price: 50, image: "230234_0.jpg", desc: "æŠ¹èŒ¶é¦™æ°£é†‡åšï¼Œå¾®è‹¦ç”œå¹³è¡¡ï¼Œç¶¿å¯†ä¸è†©ã€‚" },
            { id: 5, name: "å’–å•¡", price: 50, image: "230236_0.jpg", desc: "é˜¿æ‹‰æ¯”å¡å’–å•¡è±†ï¼Œå¸¶æŸ‘æ©˜æœé¦™ï¼Œå’–å•¡èˆ‡å¥¶é¦™å®Œç¾èåˆã€‚" },
            { id: 6, name: "æ³°å¼å¥¶èŒ¶", price: 50, image: "230235_0.jpg", desc: "æ‰‹æ¨™æ³°å¼ç´…èŒ¶å…ˆç‚’å‡ºèŒ¶é¦™ï¼Œæ³°å¥¶é¦™æ°£æ¿ƒéƒï¼Œç”œè€Œä¸è†©ã€‚" },
            { id: 7, name: "ä¼¯çˆµç´…èŒ¶", price: 50, image: "230241_0.jpg", desc: "å¤§äººç³»å£å‘³ï¼Œä½›æ‰‹æŸ‘æ¸…é¦™ï¼ŒèŒ¶é¦™èˆ‡å¥¶é¦™åœ“æ½¤èåˆã€‚" },
            { id: 8, name: "èŠ‹é¦™ç´«è–¯", price: 50, image: "230237_0.jpg", desc: "ç´°ç«ç†¬ç…®ï¼Œå£æ„Ÿç´°ç¶¿ï¼Œæ·¡æ·¡èŠ‹é¦™èˆ‡è‡ªç„¶ç´«è–¯è‰²ã€‚" },
            { id: 9, name: "å¾®é†ºè˜­å§†", price: 50, image: "230233_0.jpg", desc: "æˆå¹´äººçš„å¾®é†ºå¿«æ¨‚ï¼Œæ·¡æ·¡é…’é¦™ï¼Œå¥¶é¦™ä¸­å¸¶é†‰äººé¤˜éŸ»ã€‚" },
            { id: 10, name: "èŒ‰è‰ç¶ èŒ¶", price: 50, image: "230243.jpg", desc: "èŒ‰è‰èŠ±é¦™èˆ‡ç¶ èŒ¶æŸ”å’Œäº¤ç¹”ï¼Œæ·¡é›…èŒ¶éŸ»ï¼Œæ­é…æ»‘é †å¥¶é…ªã€‚" }
        ];

        let cart = []; 
        const menuContainer = document.getElementById('menu-list');
        const cartContainer = document.getElementById('cart-list');
        const totalEl = document.getElementById('final-total');
        const discountBadge = document.getElementById('discount-badge');
        const dateInput = document.getElementById('pickup-date');
        const loadingOverlay = document.getElementById('loading-overlay');

        function init() {
            menuContainer.innerHTML = '';
            menuData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'menu-item';
                div.innerHTML = `
                    <img src="${item.image}" alt="${item.name}" class="menu-img">
                    <div class="menu-name">${item.name}</div>
                    <div class="menu-desc">${item.desc}</div>
                    <div class="menu-price">$${item.price}</div>
                    <button class="add-btn" onclick="addToCart(${item.id})">åŠ å…¥</button>
                `;
                menuContainer.appendChild(div);
            });
            updateDateSettings('pickup');
            renderCart();
        }

        function updateDateSettings(mode) {
            const dateInput = document.getElementById('pickup-date');
            const hint = document.getElementById('date-hint');
            const addressRow = document.getElementById('address-row');
            const now = new Date();
            const currentHour = now.getHours();

            if (mode === 'delivery') {
                dateInput.disabled = true;
                dateInput.value = '';
                hint.innerText = "æé†’ï¼šå®…é…é»˜èªä¸æŒ‡å®šæ—¥æœŸå‡ºè²¨ï¼Œè‹¥éœ€æŒ‡å®šæ—¥æœŸè«‹å…ˆèˆ‡åº—å®¶è©¢å•ã€‚";
                addressRow.style.display = 'block';
            } else {
                dateInput.disabled = false;
                addressRow.style.display = 'none';

                let daysToAdd = 0;
                if (currentHour < 12) {
                    daysToAdd = 2; 
                    hint.innerText = "æé†’ï¼šä¸­åˆ 12:00 å‰ä¸‹å–®ï¼Œæœ€å¿«å¯é¸å¾Œå¤©è‡ªå– (é€±æ—¥ã€é€±ä¸€å…¬ä¼‘)";
                } else {
                    daysToAdd = 3; 
                    hint.innerText = "æé†’ï¼šå·²éä¸­åˆ 12:00ï¼Œéœ€é ç•™å‚™æ–™ï¼Œæœ€å¿«å¤§å¾Œå¤©è‡ªå– (é€±æ—¥ã€é€±ä¸€å…¬ä¼‘)";
                }

                let targetDate = new Date(now);
                targetDate.setDate(targetDate.getDate() + daysToAdd);

                while (targetDate.getDay() === 0 || targetDate.getDay() === 1) {
                    targetDate.setDate(targetDate.getDate() + 1);
                }

                const yyyy = targetDate.getFullYear();
                const mm = String(targetDate.getMonth() + 1).padStart(2, '0');
                const dd = String(targetDate.getDate()).padStart(2, '0');
                const minDate = `${yyyy}-${mm}-${dd}`;
                
                dateInput.min = minDate;
                dateInput.value = minDate;
            }
        }

        function validateDate() {
            const mode = document.querySelector('input[name="deliveryMethod"]:checked').value;
            const dateInput = document.getElementById('pickup-date');
            
            if (dateInput.disabled || !dateInput.value) return;

            const selectedDate = new Date(dateInput.value);
            const day = selectedDate.getDay();
            
            if (mode === 'å®…é…') {
                // å®…é…é‚è¼¯...
            } else {
                if (day === 0 || day === 1) {
                    alert("æŠ±æ­‰ï¼Œé€±æ—¥èˆ‡é€±ä¸€ç‚ºå…¬ä¼‘æ—¥ï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸã€‚");
                    updateDateSettings('pickup');
                }
            }
        }

        function addToCart(id) {
            const existingItem = cart.find(item => item.id === id);
            if (existingItem) existingItem.quantity++;
            else cart.push({ ...menuData.find(p => p.id === id), quantity: 1 });
            renderCart();
        }

        function renderCart() {
            cartContainer.innerHTML = '';
            let rawTotal = 0; 
            let totalCups = 0; 

            if (cart.length === 0) {
                cartContainer.innerHTML = '<div class="empty-cart-msg">è³¼ç‰©è»Šç›®å‰æ˜¯ç©ºçš„</div>';
                totalEl.innerText = '0';
                discountBadge.style.display = 'none'; 
                document.getElementById('total-cups-badge').innerText = '0'; 
                return;
            }
            cart.forEach((item, index) => {
                rawTotal += item.price * item.quantity;
                totalCups += item.quantity; 
                
                const div = document.createElement('div');
                div.className = 'cart-item';
                div.style.borderLeftColor = '#ddd'; 
                div.innerHTML = `
                    <div class="cart-info">
                        <div class="cart-title">${item.name}</div>
                        <div class="cart-subtotal">$${item.price} x ${item.quantity} = $${item.price * item.quantity}</div>
                    </div>
                    <div class="qty-control">
                        <button class="qty-btn" onclick="changeQty(${index}, -1)">-</button>
                        <span>${item.quantity}</span>
                        <button class="qty-btn" onclick="changeQty(${index}, 1)">+</button>
                    </div>
                `;
                cartContainer.appendChild(div);
            });
            
            document.getElementById('total-cups-badge').innerText = totalCups;

            if (rawTotal >= 5000) {
                let discountedPrice = Math.floor(rawTotal * 0.9);
                totalEl.innerText = discountedPrice.toLocaleString();
                discountBadge.style.display = 'inline-block'; 
                discountBadge.innerText = '9æŠ˜';
            } else if (rawTotal >= 3000) {
                let discountedPrice = Math.floor(rawTotal * 0.95);
                totalEl.innerText = discountedPrice.toLocaleString();
                discountBadge.style.display = 'inline-block'; 
                discountBadge.innerText = '95æŠ˜';
            } else {
                totalEl.innerText = rawTotal.toLocaleString();
                discountBadge.style.display = 'none';
            }
        }

        function changeQty(index, delta) {
            cart[index].quantity += delta;
            if (cart[index].quantity <= 0) cart.splice(index, 1);
            renderCart();
        }

        function processCheckout() {
            if (cart.length === 0) { alert("è«‹å…ˆåŠ å…¥å•†å“"); return; }

            const name = document.getElementById('cust-name').value.trim();
            const phone = document.getElementById('cust-phone').value.trim();
            const dateValue = document.getElementById('pickup-date').value;
            const delivery = document.querySelector('input[name="deliveryMethod"]:checked').value;
            const payment = document.querySelector('input[name="paymentMethod"]:checked').value;
            const remarks = document.getElementById('cust-remarks').value.trim(); 
            
            let fullAddress = "";
            const city = document.getElementById('cust-city').value;
            const detailAddr = document.getElementById('cust-addr-detail').value.trim();

            if(!name || !phone) { alert("è«‹å¡«å¯«å§“åèˆ‡é›»è©±"); return; }
            if(delivery === 'è‡ªå–' && !dateValue) { alert("è«‹é¸æ“‡è‡ªå–æ—¥æœŸ"); return; }
            
            if(delivery === 'å®…é…') {
                if(!city || !detailAddr) {
                    alert("å®…é…è«‹å‹™å¿…é¸æ“‡ç¸£å¸‚ä¸¦å¡«å¯«è©³ç´°åœ°å€");
                    return;
                }
                fullAddress = city + detailAddr;
            }

            let finalDateStr = dateValue;
            if (delivery === 'å®…é…') {
                finalDateStr = "å®…é…ä¸æŒ‡å®šæ—¥æœŸ (éœ€æŒ‡å®šè«‹æ´½å®¢æœ)";
            }

            let rawTotal = 0;
            let totalCups = 0;
            let orderDetails = ""; 
            let msgDetails = ""; 
            cart.forEach(p => {
                rawTotal += p.price * p.quantity;
                totalCups += p.quantity;
                orderDetails += `${p.name}x${p.quantity}, `;
                msgDetails += `- ${p.name} x ${p.quantity} = $${p.price*p.quantity}\n`;
            });
            
            if (delivery === 'å®…é…' && totalCups % 6 !== 0) {
                alert(`å®…é…è¨‚å–®ç‚ºäº†é˜²æ­¢é‹é€ç¢°æ’ï¼Œæ•¸é‡å¿…é ˆæ˜¯ 6 çš„å€æ•¸ã€‚\nç›®å‰æ•¸é‡ï¼š${totalCups} å€‹\nå»ºè­°èª¿æ•´ç‚º ${Math.ceil(totalCups/6)*6} æˆ– ${Math.floor(totalCups/6)*6} å€‹`);
                return; 
            }

            let productFinalPrice = rawTotal;
            let discountText = "";
            if (rawTotal >= 5000) {
                productFinalPrice = Math.floor(rawTotal * 0.9);
                orderDetails += `(æ»¿é¡9æŠ˜)`;
                discountText = "(å•†å“å·²æŠ˜ 10%)";
            } else if (rawTotal >= 3000) {
                productFinalPrice = Math.floor(rawTotal * 0.95);
                orderDetails += `(æ»¿é¡95æŠ˜)`;
                discountText = "(å•†å“å·²æŠ˜ 5%)";
            }

            let shippingFee = 0;
            if (delivery === 'å®…é…') {
                if(totalCups <= 12) shippingFee = 130;
                else if(totalCups <= 48) shippingFee = 170;
                else shippingFee = 210;
            }

            let finalAllPrice = productFinalPrice + shippingFee;

            let confirmMsg = `ã€è¨‚å–®ç¢ºèªã€‘\n---------------------\n`;
            confirmMsg += `ç¸½æ•¸é‡ï¼š${totalCups} å€‹\n`;
            confirmMsg += msgDetails;
            confirmMsg += `---------------------\n`;
            if(discountText) confirmMsg += `å•†å“å°è¨ˆï¼š$${productFinalPrice} ${discountText}\n`;
            else confirmMsg += `å•†å“å°è¨ˆï¼š$${productFinalPrice}\n`;
            
            if(shippingFee > 0) confirmMsg += `é‹è²»ï¼š$${shippingFee} (æ–°ç«¹ç‰©æµå†·è—)\n`;
            
            confirmMsg += `===============\n`;
            confirmMsg += `åˆè¨ˆç¸½é‡‘é¡ï¼š$${finalAllPrice}\n`;
            confirmMsg += `===============\n`;
            confirmMsg += `å–è²¨ï¼š${delivery}\n`;
            if(delivery === 'è‡ªå–') confirmMsg += `æ—¥æœŸï¼š${finalDateStr}\n`;
            else confirmMsg += `æ—¥æœŸï¼š${finalDateStr}\n`; 
            
            confirmMsg += `å§“åï¼š${name}\n`;
            confirmMsg += `é›»è©±ï¼š${phone}\n`;
            if(delivery === 'å®…é…') confirmMsg += `åœ°å€ï¼š${fullAddress}\n`;
            if(remarks) confirmMsg += `å‚™è¨»ï¼š${remarks}\n`;
            confirmMsg += `ä»˜æ¬¾ï¼š${payment === 'linepay' ? 'LINE Pay' : 'éŠ€è¡ŒåŒ¯æ¬¾'}\n`;
            confirmMsg += `\nè«‹ç¢ºèªè³‡æ–™ç„¡èª¤ï¼Œé»æ“Šã€Œç¢ºå®šã€é€å‡ºè¨‚å–®ã€‚`;

            if (!confirm(confirmMsg)) {
                return; 
            }

            loadingOverlay.style.display = 'flex';
            document.getElementById('submit-btn').disabled = true;

            let fullOrderInfo = orderDetails + ` [å…±${totalCups}å€‹]`;
            if(shippingFee > 0) fullOrderInfo += ` [é‹è²»$${shippingFee}]`;
            if(remarks) fullOrderInfo += ` [å‚™è¨»: ${remarks}]`;

            let formData = new FormData();
            formData.append(FORM_FIELDS.orderContent, fullOrderInfo); 
            formData.append(FORM_FIELDS.name, name);                  
            formData.append(FORM_FIELDS.phone, phone);                
            formData.append(FORM_FIELDS.payment, payment);            
            formData.append(FORM_FIELDS.delivery, delivery);          
            formData.append(FORM_FIELDS.address, fullAddress);        
            formData.append(FORM_FIELDS.date, finalDateStr);          
            formData.append(FORM_FIELDS.cups, totalCups);             
            formData.append(FORM_FIELDS.subtotal, productFinalPrice); 
            formData.append(FORM_FIELDS.shipping, shippingFee);        
            formData.append(FORM_FIELDS.totalPrice, finalAllPrice);   

            fetch(GOOGLE_FORM_URL, {
                method: "POST",
                body: formData,
                mode: "no-cors"
            }).then(() => {
                showReceipt(name, phone, finalDateStr, delivery, payment, fullAddress, finalAllPrice, totalCups, shippingFee, remarks);
                loadingOverlay.style.display = 'none';
            }).catch(err => {
                alert("è¨‚å–®å‚³é€å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚\n" + err);
                loadingOverlay.style.display = 'none';
                document.getElementById('submit-btn').disabled = false;
            });
        }

        function showReceipt(name, phone, dateStr, delivery, payment, fullAddress, finalAllPrice, totalCups, shippingFee, remarks) {
            const now = new Date();
            document.getElementById('receipt-time').innerText = "è¨‚å–®æ™‚é–“ï¼š" + now.toLocaleString('zh-TW', {hour12: false});
            
            let itemsHtml = '';
            cart.forEach(p => {
                itemsHtml += `<div class="receipt-row"><span>${p.name} x ${p.quantity}</span><span>$${p.price * p.quantity}</span></div>`;
            });
            if(shippingFee > 0) {
                itemsHtml += `<div class="receipt-row bold" style="border-top:none; margin-top:5px; font-size:0.95rem;"><span>é‹è²» (æ–°ç«¹ç‰©æµ)</span><span>$${shippingFee}</span></div>`;
            }
            document.getElementById('receipt-items').innerHTML = itemsHtml;
            document.getElementById('receipt-total').innerText = "NT$ " + finalAllPrice;

            document.getElementById('receipt-cups').innerText = totalCups + " å€‹";
            document.getElementById('receipt-name').innerText = name;
            document.getElementById('receipt-phone').innerText = phone;
            document.getElementById('receipt-delivery').innerText = delivery;
            document.getElementById('receipt-date').innerText = dateStr;
            
            if(delivery === 'å®…é…') {
                document.getElementById('receipt-address-row').style.display = 'flex';
                document.getElementById('receipt-address').innerText = fullAddress;
            } else {
                document.getElementById('receipt-address-row').style.display = 'none';
            }

            if(remarks) {
                document.getElementById('receipt-remarks-row').style.display = 'flex';
                document.getElementById('receipt-remarks').innerText = remarks;
            } else {
                document.getElementById('receipt-remarks-row').style.display = 'none';
            }

            const bankArea = document.getElementById('bank-info-area');
            const lineBtn = document.getElementById('linepay-btn');

            if(payment === 'linepay') {
                bankArea.style.display = 'none';
                lineBtn.style.display = 'block';
                lineBtn.href = LINE_PAY_LINK;
                lineBtn.innerText = "å‰å¾€ LINE Pay ä»˜æ¬¾ ($" + finalAllPrice + ")";
            } else {
                bankArea.style.display = 'block';
                lineBtn.style.display = 'none';
            }

            document.getElementById('shop-view').style.display = 'none';
            document.getElementById('receipt-view').style.display = 'block';
            window.scrollTo(0, 0);
        }

        init();
    </script>
</body>
</html>
