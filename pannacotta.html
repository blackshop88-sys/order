<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>å¥¶é…ªè¨ˆç®— V7 (å¯ç·¨è¼¯ç‰ˆ)</title>
    <style>
        :root { --primary: #2b6cb0; --bg: #f7fafc; --border: #e2e8f0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: #333; padding-bottom: 120px; }
        
        /* é ‚éƒ¨æ¨™é¡Œ */
        header { background: white; padding: 12px 15px; position: sticky; top: 0; z-index: 10; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        h2 { margin: 0 0 10px 0; font-size: 1.1rem; text-align: center; color: #2d3748; display: flex; justify-content: space-between; align-items: center;}
        
        /* è¡¨é ­ */
        .table-header { display: flex; font-size: 0.75rem; color: #718096; padding: 5px 10px 5px 10px; border-bottom: 1px solid #cbd5e0; background: #fff; }
        .th-name { width: 35%; flex-shrink: 0; }
        .th-data { flex-grow: 1; display: flex; justify-content: space-between; padding-left: 10px; }
        .th-item { width: 20%; text-align: center; white-space: nowrap; }

        /* åˆ—è¡¨æ¨£å¼ */
        .list-container { background: white; }
        .row-item { display: flex; align-items: center; border-bottom: 1px solid var(--border); padding: 8px 10px; height: 50px; }
        
        .col-left { width: 35%; flex-shrink: 0; display: flex; flex-direction: column; justify-content: center; border-right: 1px solid #edf2f7; padding-right: 5px; }
        .flavor-name { font-size: 0.95rem; font-weight: bold; color: var(--primary); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer;}
        .cup-input { width: 100%; box-sizing: border-box; padding: 4px; border: 1px solid #cbd5e0; border-radius: 4px; text-align: center; font-size: 1rem; font-weight: bold; background: #ebf8ff; color: #2b6cb0; }
        
        .col-right { flex-grow: 1; display: flex; overflow-x: auto; align-items: center; padding-left: 10px; }
        .col-right::-webkit-scrollbar { display: none; }
        .data-box { min-width: 19%; text-align: center; font-size: 0.9rem; font-weight: 500; color: #4a5568; display: flex; flex-direction: column; justify-content: center; }
        .data-val { display: block; }
        .data-unit { font-size: 0.6rem; color: #a0aec0; margin-top: -2px;}

        /* åº•éƒ¨ç¸½é‡å„€è¡¨æ¿ */
        .footer-dashboard { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: #2d3748; color: white; 
            padding: 10px 15px; 
            z-index: 50; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            transition: background 0.3s;
        }
        /* ç·¨è¼¯æ¨¡å¼ä¸‹çš„åº•éƒ¨é¡è‰² */
        .footer-dashboard.editing-mode { background: #2b6cb0; border-top: 4px solid #f6ad55; }

        .totals-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px 15px;
            font-size: 0.8rem; margin-bottom: 10px;
        }
        .t-item { white-space: nowrap; }
        .t-label { color: #a0aec0; font-size: 0.75rem; margin-right: 2px; }
        .t-val { font-weight: bold; color: #63b3ed; font-size: 0.95rem; }
        .t-val.highlight { color: #f6ad55; }
        
        /* åº•éƒ¨æŒ‰éˆ•å€ */
        .footer-btns { display: flex; gap: 10px; }
        .btn-save { 
            background: #48bb78; color: white; border: none; flex: 1; height: 45px;
            border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); white-space: nowrap;
        }
        .btn-cancel-edit {
            background: #e53e3e; color: white; border: none; width: 80px; height: 45px;
            border-radius: 8px; font-weight: bold; font-size: 0.9rem; cursor: pointer;
            display: none; /* é è¨­éš±è— */
        }

        /* æ­·å²ç´€éŒ„å€ */
        #historySection { display: none; background: white; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; overflow-y: auto; }
        .history-header { padding: 15px 15px 5px 15px; background: #edf2f7; border-bottom: 1px solid #cbd5e0; }
        .history-top-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .date-picker { padding: 8px; font-size: 1rem; border: 1px solid #cbd5e0; border-radius: 6px; }
        
        .date-chips-container { display: flex; overflow-x: auto; padding-bottom: 10px; gap: 8px; scrollbar-width: none; }
        .date-chips-container::-webkit-scrollbar { display: none; }
        .date-chip { background: white; border: 1px solid #cbd5e0; color: #4a5568; padding: 6px 12px; border-radius: 15px; font-size: 0.85rem; white-space: nowrap; cursor: pointer; }
        .date-chip.active { background: #4299e1; color: white; border-color: #4299e1; font-weight: bold; }

        .history-list { padding: 15px; padding-bottom: 60px; }
        .history-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; margin-bottom: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border-left: 4px solid #cbd5e0; }
        
        .h-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 1px solid #f0f0f0;}
        .h-time { font-size: 0.9rem; font-weight: bold; color: #2d3748; }
        .h-actions { display: flex; gap: 10px; }
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1.1rem; padding: 2px 5px; }
        
        .h-summary { background: #ebf8ff; padding: 8px; border-radius: 4px; margin-bottom: 8px; font-size: 0.85rem; color: #2c5282; line-height: 1.6; }
        .h-detail { font-size: 0.85rem; color: #718096; white-space: pre-wrap; line-height: 1.4; }

        /* ç·¨è¼¯å½ˆçª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 85%; max-width: 350px; padding: 20px; border-radius: 12px; }
        .form-row { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
        .form-row label { font-size: 0.9rem; color: #4a5568; }
        .form-row input { width: 80px; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; text-align: right; }
        .modal-btn-group { margin-top: 20px; display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 10px; border: none; border-radius: 6px; font-weight: bold; }

    </style>
</head>
<body>

    <header>
        <h2>
            <span>ğŸ® ææ–™è¨ˆç®— V7</span>
            <button onclick="toggleHistory()" style="background:#4299e1; color:white; border:none; border-radius:4px; padding:5px 12px; font-size:0.8rem; cursor:pointer;">ğŸ“… æŸ¥æ­·å²</button>
        </h2>
        
        <div class="table-header">
            <div class="th-name">å£å‘³ / æ¯æ•¸</div>
            <div class="th-data">
                <div class="th-item">å¥¶</div>
                <div class="th-item">é®®æ²¹</div>
                <div class="th-item">ç³–</div>
                <div class="th-item">å‰</div>
                <div class="th-item">ç²‰/é…’</div>
            </div>
        </div>
    </header>

    <div id="listContainer" class="list-container">
        </div>

    <div id="footerDashboard" class="footer-dashboard">
        <div class="totals-grid">
            <div class="t-item"><span class="t-label">ç¸½æ¯æ•¸:</span><span id="t-cups" class="t-val" style="color:white;">0</span></div>
            <div class="t-item"><span class="t-label">é®®å¥¶:</span><span id="t-milk" class="t-val">0</span></div>
            <div class="t-item"><span class="t-label">é®®æ²¹:</span><span id="t-cream" class="t-val">0</span></div>
            <div class="t-item"><span class="t-label">ç¸½ç³–:</span><span id="t-sugar" class="t-val highlight">0</span></div>
            <div class="t-item" style="grid-column: span 2;"><span class="t-label">ç¸½å‰åˆ©ä¸:</span><span id="t-gelatin" class="t-val highlight">0</span> <span style="font-size:0.7rem; color:#aaa;">ç‰‡</span></div>
        </div>
        
        <div class="footer-btns">
            <button id="btnCancelEdit" class="btn-cancel-edit" onclick="cancelEditMode()">å–æ¶ˆ</button>
            <button id="btnSave" class="btn-save" onclick="handleSave()">ğŸ’¾ å­˜æª”</button>
        </div>
    </div>

    <div id="historySection">
        <div class="history-header">
            <div class="history-top-row">
                <strong>ğŸ“œ æ­·å²ç®¡ç†</strong>
                <button onclick="toggleHistory()" style="background:transparent; border:none; font-size:1.5rem; color:#718096;">Ã—</button>
            </div>
            
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                <label style="font-size:0.8rem; color:#718096;">é¸æ“‡æ—¥æœŸ:</label>
                <input type="date" id="historyDateInput" class="date-picker" onchange="onDateInputChange()">
            </div>
            <div id="dateChips" class="date-chips-container"></div>
        </div>

        <div id="historyListDisplay" class="history-list"></div>
        
        <div style="text-align:center; padding-bottom:50px;">
             <button onclick="clearAllHistory()" style="color:#e53e3e; background:none; border:1px solid #e53e3e; padding:5px 10px; border-radius:4px; font-size:0.8rem;">æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:#2b6cb0;" id="modalTitle">ç·¨è¼¯é…æ–¹</h3>
            <p style="font-size:0.8rem; color:#e53e3e;">ä¿®æ”¹æ¯ 1 æ¯çš„åŸºç¤ç”¨é‡</p>
            <div class="form-row"><label>é®®å¥¶ (ml)</label><input type="number" id="e-milk" step="0.1"></div>
            <div class="form-row"><label>é®®å¥¶æ²¹ (g)</label><input type="number" id="e-cream" step="0.1"></div>
            <div class="form-row"><label>ç³– (g)</label><input type="number" id="e-sugar" step="0.1"></div>
            <div class="form-row"><label>å‰åˆ©ä¸ (ç‰‡)</label><input type="number" id="e-gelatin" step="0.1"></div>
            <div class="form-row"><label id="e-powder-label">ç²‰é¡ (g)</label><input type="number" id="e-powder" step="0.1"></div>
            <div class="modal-btn-group">
                <button class="modal-btn" style="background:#ed8936; color:white;" onclick="saveRecipeEdit()">ç¢ºèªä¿®æ”¹</button>
                <button class="modal-btn" style="background:#edf2f7; color:#333;" onclick="closeModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        const defaultRecipes = {
            "ç¶“å…¸åŸå‘³": { milk: 66, cream: 46.2, sugar: 6, gelatin: 0.4, powder: 0 },
            "å·§å…‹åŠ›": { milk: 77, cream: 38.5, sugar: 11.6, gelatin: 0.6, powder: 2.8 },
            "èŠéº»": { milk: 55, cream: 55, sugar: 6.6, gelatin: 0.5, powder: 3.6 },
            "æŠ¹èŒ¶": { milk: 66, cream: 46.2, sugar: 6.9, gelatin: 0.4, powder: 1.4 },
            "å’–å•¡": { milk: 71.5, cream: 38.5, sugar: 8, gelatin: 0.6, powder: 1.4 },
            "ä¼¯çˆµç´…èŒ¶": { milk: 82.5, cream: 38.5, sugar: 6.7, gelatin: 0.4, powder: 1.8 },
            "æ³°å¼å¥¶èŒ¶": { milk: 88, cream: 44, sugar: 9.1, gelatin: 0.5, powder: 7.7 },
            "èŠ‹é¦™ç´«è–¯": { milk: 88, cream: 33, sugar: 8.8, gelatin: 0.5, powder: 4.4 },
            "åè–°èŒ‰ç¶ ": { milk: 82.5, cream: 38.5, sugar: 6.7, gelatin: 0.4, powder: 1.5 },
            "å¾®é†ºè˜­å§†": { milk: 66, cream: 46.2, sugar: 6, gelatin: 0.4, powder: 6 }
        };

        const displayOrder = [
            "ç¶“å…¸åŸå‘³", "å·§å…‹åŠ›", "èŠéº»", "æŠ¹èŒ¶",
            "ä¼¯çˆµç´…èŒ¶", "æ³°å¼å¥¶èŒ¶", "èŠ‹é¦™ç´«è–¯", "åè–°èŒ‰ç¶ ", "å¾®é†ºè˜­å§†",
            "å’–å•¡"
        ];

        let recipes = {};
        let currentEditFlavor = "";
        let editingRecordId = null; // ç”¨ä¾†è¿½è¹¤ç›®å‰æ˜¯å¦æ­£åœ¨ç·¨è¼¯æŸä¸€ç­†æ­·å²ç´€éŒ„

        function init() {
            const saved = localStorage.getItem('pannaRecipes_v4');
            if(saved) {
                recipes = JSON.parse(saved);
                for(let k in defaultRecipes) if(!recipes[k]) recipes[k] = defaultRecipes[k];
            } else {
                recipes = JSON.parse(JSON.stringify(defaultRecipes));
            }
            renderList();
            document.getElementById('historyDateInput').valueAsDate = new Date();
        }

        function renderList() {
            const container = document.getElementById('listContainer');
            container.innerHTML = "";
            displayOrder.forEach(flavor => {
                if(!recipes[flavor]) return;
                const r = recipes[flavor];
                const div = document.createElement('div');
                div.className = "row-item";
                div.innerHTML = `
                    <div class="col-left">
                        <div class="flavor-name" onclick="openEdit('${flavor}')">${flavor}</div>
                        <input type="number" class="cup-input" id="in-${flavor}" placeholder="0" oninput="calc()" onclick="this.select()">
                    </div>
                    <div class="col-right">
                        <div class="data-box"><span class="data-val" id="out-m-${flavor}">-</span><span class="data-unit">ml</span></div>
                        <div class="data-box"><span class="data-val" id="out-c-${flavor}">-</span><span class="data-unit">g</span></div>
                        <div class="data-box"><span class="data-val" id="out-s-${flavor}">-</span><span class="data-unit">g</span></div>
                        <div class="data-box"><span class="data-val" id="out-g-${flavor}">-</span><span class="data-unit">ç‰‡</span></div>
                        <div class="data-box"><span class="data-val" id="out-p-${flavor}">-</span><span class="data-unit">${flavor==="å¾®é†ºè˜­å§†"?"ml":"g"}</span></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function calc() {
            let totalCups = 0, totalMilk = 0, totalCream = 0, totalSugar = 0, totalGelatin = 0;
            
            for(let flavor in recipes) {
                const r = recipes[flavor];
                const input = document.getElementById(`in-${flavor}`);
                if(!input) continue;
                const val = parseFloat(input.value) || 0;
                
                document.getElementById(`out-m-${flavor}`).textContent = val > 0 ? (r.milk * val).toFixed(0) : '-';
                document.getElementById(`out-c-${flavor}`).textContent = val > 0 ? (r.cream * val).toFixed(0) : '-';
                document.getElementById(`out-s-${flavor}`).textContent = val > 0 ? (r.sugar * val).toFixed(0) : '-';
                document.getElementById(`out-g-${flavor}`).textContent = val > 0 ? (r.gelatin * val).toFixed(1) : '-';
                document.getElementById(`out-p-${flavor}`).textContent = val > 0 ? (r.powder * val).toFixed(1) : '-';
                
                if (val > 0) {
                    totalCups += val;
                    totalMilk += (r.milk * val);
                    totalCream += (r.cream * val);
                    totalSugar += (r.sugar * val);
                    totalGelatin += (r.gelatin * val);
                }
            }
            
            document.getElementById('t-cups').textContent = totalCups;
            document.getElementById('t-milk').textContent = totalMilk.toFixed(0);
            document.getElementById('t-cream').textContent = totalCream.toFixed(0);
            document.getElementById('t-sugar').textContent = totalSugar.toFixed(0);
            document.getElementById('t-gelatin').textContent = totalGelatin.toFixed(1);
        }

        // --- æ ¸å¿ƒå­˜æª”é‚è¼¯ (æ–°å¢æˆ–æ›´æ–°) ---
        function handleSave() {
            const today = new Date();
            // å¦‚æœæ˜¯ç·¨è¼¯èˆŠç´€éŒ„ï¼Œä¿æŒèˆŠç´€éŒ„çš„æ—¥æœŸèˆ‡Keyï¼Œåªæ›´æ–°å…§å®¹
            // å¦‚æœæ˜¯æ–°ç´€éŒ„ï¼Œæ‰ç”¢ç”Ÿæ–°æ—¥æœŸ
            
            let details = [];
            let rawCounts = {}; // V7: å„²å­˜åŸå§‹æ¯æ•¸ï¼Œä»¥ä¾¿ä¸‹æ¬¡ç·¨è¼¯å›å¡«

            displayOrder.forEach(flavor => {
                const input = document.getElementById(`in-${flavor}`);
                const val = parseFloat(input.value) || 0;
                rawCounts[flavor] = val; // è¨˜éŒ„æ¯æ•¸
                if(val > 0) details.push(`${flavor} x${val}`);
            });
            
            if(details.length === 0 && !editingRecordId) { 
                alert("è«‹è¼¸å…¥æ•¸é‡"); return; 
            }

            const summaryStr = `ç¸½æ¯æ•¸:${document.getElementById('t-cups').textContent} | é®®å¥¶:${document.getElementById('t-milk').textContent}ml | é®®æ²¹:${document.getElementById('t-cream').textContent}g | ç³–:${document.getElementById('t-sugar').textContent}g | å‰:${document.getElementById('t-gelatin').textContent}ç‰‡`;

            let history = JSON.parse(localStorage.getItem('pannaHistory_v4') || "[]");

            if (editingRecordId) {
                // --- æ›´æ–°ç¾æœ‰ç´€éŒ„ ---
                const index = history.findIndex(h => h.id === editingRecordId);
                if(index !== -1) {
                    history[index].summary = summaryStr;
                    history[index].detailText = details.join(", ");
                    history[index].rawCounts = rawCounts; // æ›´æ–°åŸå§‹æ•¸æ“š
                    alert("âœ… è³‡æ–™å·²æ›´æ–°ï¼");
                }
            } else {
                // --- å»ºç«‹æ–°ç´€éŒ„ ---
                const record = {
                    id: Date.now(),
                    time: today.getHours() + ":" + (today.getMinutes()<10?'0':'') + today.getMinutes(),
                    dateKey: today.toISOString().split('T')[0],
                    summary: summaryStr,
                    detailText: details.join(", "),
                    rawCounts: rawCounts // V7 æ–°å¢
                };
                history.push(record);
                alert("âœ… å·²å­˜æª”");
            }
            
            localStorage.setItem('pannaHistory_v4', JSON.stringify(history));
            
            // å­˜æª”/æ›´æ–°å®Œæˆå¾Œçš„æ¸…ç†å‹•ä½œ
            cancelEditMode(); // é€€å‡ºç·¨è¼¯æ¨¡å¼
            toggleHistory();  // é–‹å•Ÿæ­·å²åˆ—è¡¨ç¢ºèª
        }

        // --- ç·¨è¼¯åŠŸèƒ½é‚è¼¯ ---
        function loadRecordForEdit(id) {
            const history = JSON.parse(localStorage.getItem('pannaHistory_v4') || "[]");
            const record = history.find(h => h.id === id);
            
            if(!record) return;
            if(!record.rawCounts) {
                alert("âš ï¸ æ­¤ç­†ç‚ºèˆŠç‰ˆæ ¼å¼è³‡æ–™ï¼Œåƒ…èƒ½æª¢è¦–ç„¡æ³•ç·¨è¼¯ã€‚\n(æ–°å„²å­˜çš„è³‡æ–™å³å¯æ”¯æ´ç·¨è¼¯åŠŸèƒ½)");
                return;
            }

            // 1. è¨­å®šç·¨è¼¯ç‹€æ…‹
            editingRecordId = id;
            
            // 2. å°‡æ•¸æ“šå›å¡«åˆ°è¼¸å…¥æ¡†
            // å…ˆæ¸…ç©º
            displayOrder.forEach(f => {
                const input = document.getElementById(`in-${f}`);
                if(input) input.value = "";
            });
            // å¡«å…¥
            for(let flavor in record.rawCounts) {
                const input = document.getElementById(`in-${flavor}`);
                if(input) input.value = record.rawCounts[flavor];
            }

            // 3. è§¸ç™¼è¨ˆç®—æ›´æ–°ä»‹é¢
            calc();

            // 4. è®Šæ›´ä»‹é¢ç‚ºã€Œç·¨è¼¯æ¨¡å¼ã€
            const footer = document.getElementById('footerDashboard');
            const btnSave = document.getElementById('btnSave');
            const btnCancel = document.getElementById('btnCancelEdit');
            
            footer.classList.add('editing-mode');
            btnSave.textContent = "ğŸ”„ æ›´æ–°è³‡æ–™";
            btnSave.style.background = "#4299e1"; // è—è‰²
            btnCancel.style.display = "block";

            // 5. é—œé–‰æ­·å²è¦–çª—ï¼Œå›åˆ°ä¸»ç•«é¢
            document.getElementById('historySection').style.display = "none";
            
            // æç¤ºç”¨æˆ¶
            // alert(`å·²è¼‰å…¥ ${record.time} çš„è³‡æ–™ï¼Œä¿®æ”¹å¾Œè«‹æŒ‰ã€Œæ›´æ–°è³‡æ–™ã€ã€‚`);
        }

        function cancelEditMode() {
            editingRecordId = null;
            // æ¸…ç©ºè¼¸å…¥
            displayOrder.forEach(f => {
                const input = document.getElementById(`in-${f}`);
                if(input) input.value = "";
            });
            calc();

            // é‚„åŸä»‹é¢
            const footer = document.getElementById('footerDashboard');
            const btnSave = document.getElementById('btnSave');
            const btnCancel = document.getElementById('btnCancelEdit');
            
            footer.classList.remove('editing-mode');
            btnSave.textContent = "ğŸ’¾ å­˜æª”";
            btnSave.style.background = "#48bb78"; // ç¶ è‰²
            btnCancel.style.display = "none";
        }

        // --- æ­·å²ç´€éŒ„ä»‹é¢ ---
        function toggleHistory() {
            const section = document.getElementById('historySection');
            section.style.display = (section.style.display === 'block') ? 'none' : 'block';
            if(section.style.display === 'block') {
                updateDateChips(); 
                loadHistoryByDate();
            }
        }

        function onDateInputChange() {
            loadHistoryByDate();
            updateDateChips();
        }

        function updateDateChips() {
            const history = JSON.parse(localStorage.getItem('pannaHistory_v4') || "[]");
            const dates = [...new Set(history.map(item => item.dateKey))];
            dates.sort((a, b) => new Date(b) - new Date(a));

            const container = document.getElementById('dateChips');
            container.innerHTML = "";
            const currentDate = document.getElementById('historyDateInput').value;

            if(dates.length === 0) {
                container.innerHTML = "<span style='padding:5px; color:#cbd5e0;'>å°šç„¡å­˜æª”è³‡æ–™</span>";
                return;
            }

            dates.forEach(date => {
                const btn = document.createElement('div');
                btn.className = 'date-chip ' + (date === currentDate ? 'active' : '');
                btn.textContent = date;
                btn.onclick = () => {
                    document.getElementById('historyDateInput').value = date;
                    loadHistoryByDate();
                    updateDateChips();
                };
                container.appendChild(btn);
            });
        }

        function loadHistoryByDate() {
            const targetDate = document.getElementById('historyDateInput').value;
            const listDiv = document.getElementById('historyListDisplay');
            const history = JSON.parse(localStorage.getItem('pannaHistory_v4') || "[]");
            
            const filtered = history.filter(h => h.dateKey === targetDate).reverse();
            
            listDiv.innerHTML = "";
            if(filtered.length === 0) {
                listDiv.innerHTML = `<div style="text-align:center; color:#a0aec0; margin-top:20px;">ğŸ“… è©²æ—¥æœŸç„¡è³‡æ–™</div>`;
                return;
            }
            
            filtered.forEach(item => {
                const isEditable = item.rawCounts ? true : false;
                const div = document.createElement('div');
                div.className = "history-card";
                div.innerHTML = `
                    <div class="h-header">
                        <span class="h-time">â° ${item.time}</span>
                        <div class="h-actions">
                            ${isEditable ? `<button class="btn-icon" title="ç·¨è¼¯" onclick="loadRecordForEdit(${item.id})">âœï¸</button>` : ''}
                            <button class="btn-icon" title="åˆªé™¤" style="color:#e53e3e;" onclick="deleteItem(${item.id})">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <div class="h-summary">${item.summary}</div>
                    <div class="h-detail">${item.detailText}</div>
                `;
                listDiv.appendChild(div);
            });
        }
        
        function deleteItem(id) {
            if(!confirm("åˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ")) return;
            let history = JSON.parse(localStorage.getItem('pannaHistory_v4') || "[]");
            history = history.filter(h => h.id !== id);
            localStorage.setItem('pannaHistory_v4', JSON.stringify(history));
            
            // å¦‚æœåˆªé™¤çš„æ˜¯æ­£åœ¨ç·¨è¼¯çš„é€™ç­†ï¼Œå¼·åˆ¶é€€å‡ºç·¨è¼¯æ¨¡å¼
            if(editingRecordId === id) {
                cancelEditMode();
            }

            updateDateChips();
            loadHistoryByDate();
        }
        
        function clearAllHistory() {
            if(confirm("ç¢ºå®šæ¸…ç©ºã€æ‰€æœ‰ã€‘æ­·å²è³‡æ–™ï¼Ÿ")) {
                localStorage.removeItem('pannaHistory_v4');
                cancelEditMode();
                updateDateChips();
                loadHistoryByDate();
            }
        }

        function openEdit(flavor) {
            currentEditFlavor = flavor;
            const r = recipes[flavor];
            document.getElementById('modalTitle').textContent = flavor;
            document.getElementById('e-milk').value = r.milk;
            document.getElementById('e-cream').value = r.cream;
            document.getElementById('e-sugar').value = r.sugar;
            document.getElementById('e-gelatin').value = r.gelatin;
            document.getElementById('e-powder').value = r.powder;
            document.getElementById('e-powder-label').textContent = (flavor==="å¾®é†ºè˜­å§†") ? "é…’ (ml)" : "ç²‰é¡ (g)";
            document.getElementById('editModal').style.display = "flex";
        }
        function closeModal() { document.getElementById('editModal').style.display = "none"; }
        function saveRecipeEdit() {
            if(!confirm(`ç¢ºå®šä¿®æ”¹ã€${currentEditFlavor}ã€‘é…æ–¹ï¼Ÿ`)) return;
            recipes[currentEditFlavor] = {
                milk: parseFloat(document.getElementById('e-milk').value)||0,
                cream: parseFloat(document.getElementById('e-cream').value)||0,
                sugar: parseFloat(document.getElementById('e-sugar').value)||0,
                gelatin: parseFloat(document.getElementById('e-gelatin').value)||0,
                powder: parseFloat(document.getElementById('e-powder').value)||0,
            };
            localStorage.setItem('pannaRecipes_v4', JSON.stringify(recipes));
            closeModal();
            calc();
            alert("å·²æ›´æ–°é…æ–¹");
        }

        init();
    </script>
</body>
</html>
